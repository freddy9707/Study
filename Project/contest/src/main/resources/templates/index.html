<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <title>Temple</title>
    </head>
    <body>
        <!-- 지도를 표시할 div 입니다 -->
        <div id="map" style="width:100%;height:500px;"></div>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5db5bc5cb635e2c58b02d573f5402a27"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            var data = /*[[${temple}]]*/ 'default';
            var data2 = /*[[${boundary}]]*/ 'default';
            /*]]>*/

            var temple = [];
            for (var i = 0; i < data.length; i++) {
                var info = JSON.parse(data[i]);
                temple.push({"name":info.name, "tel":info.tel, "lat":info.lat, "lon":info.lon});
            }

            var boundary = [];
            for (var i = 0; i < data2.length; i++) {
                var info = JSON.parse(data2[i]);
                var tmp = {"name":info.name, "coordinates":[]};
                for (var j = 0; j < info.coordinates.length; j++) {
                    tmp["coordinates"].push([info.coordinates[j][0], info.coordinates[j][1]]);
                }
                boundary.push(tmp);
            }
            /*
            for (var i = 0; i < boundary.length; i++) {
                alert(boundary[i].name);
                for (var j = 0; j < boundary[i].coordinates.length; j++) {
                    alert(boundary[i].coordinates[j][0] + " " + boundary[i].coordinates[j][1]);
                }
            }
            */

            // 내 위치 설정하려면 이 안에서 현재 위경도 받을 수 있음
            /*
            navigator.geolocation.getCurrentPosition(success);
            function success(pos) {
                var lat = pos.coords.latitude;
                var lon = pos.coords.longitude;
            }
            */

            var lat = 37.566535;
            var lon = 126.9779692;
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = {
                    center: new kakao.maps.LatLng(lat, lon), // 지도의 중심좌표
                    level: 8 // 지도의 확대 레벨
                };

            // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
            var map = new kakao.maps.Map(mapContainer, mapOption);

            // 마커를 표시할 위치와 title 객체 배열입니다
            var positions = []
            for (var i = 0; i < temple.length; i++) {
                positions.push({title:temple[i]["name"], lat:temple[i]["lat"], lon:temple[i]["lon"], latlng: new kakao.maps.LatLng(temple[i]["lat"], temple[i]["lon"])});
            }

            // 마커 이미지의 이미지 주소입니다
            var imageSrc = "https://t1.kakaocdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
            for (var i = 0; i < positions.length; i ++) {
                // 마커 이미지의 이미지 크기 입니다
                var imageSize = new kakao.maps.Size(24, 35);
                // 마커 이미지를 생성합니다
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);
                // 마커를 생성합니다
                var marker = new kakao.maps.Marker({
                    map: map, // 마커를 표시할 지도
                    position: positions[i].latlng, // 마커를 표시할 위치
                    title : positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                    image : markerImage // 마커 이미지
                });

                // 지도에 표시할 원을 생성합니다
                var circle = new kakao.maps.Circle({
                    center : positions[i].latlng,  // 원의 중심좌표 입니다
                    radius: 5000, // 미터 단위의 원의 반지름입니다
                    strokeWeight: 5, // 선의 두께입니다
                    strokeColor: '#75B8FA', // 선의 색깔입니다
                    strokeOpacity: 1, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
                    strokeStyle: 'dashed', // 선의 스타일 입니다
                    fillColor: '#CFE7FF', // 채우기 색깔입니다
                    fillOpacity: 0.7  // 채우기 불투명도 입니다
                });
                // 지도에 원을 표시합니다
                circle.setMap(map);
            }

            // 거리
            var linePath;
            var lineLine = new kakao.maps.Polyline();
            var distance;
            for (var i = 0; i < positions.length; i++) {
                if (i != 0) {
                    linePath = [positions[i - 1].latlng, positions[i].latlng]; //라인을 그리려면 두 점이 있어야하니깐 두 점을 지정했습니다
                }
                //lineLine.setPath(linePath);

                var drawLine = new kakao.maps.Polyline({
                    map: map, // 선을 표시할 지도입니다
                    path: linePath,
                    strokeWeight: 3, // 선의 두께입니다
                    strokeColor: '#db4040', // 선의 색깔입니다
                    strokeOpacity: 1, // 선의 불투명도입니다 0에서 1 사이값이며 0에 가까울수록 투명합니다
                    strokeStyle: 'solid' // 선의 스타일입니다
                });
                if (i != 0) {
                    distance = Math.round(lineLine.getLength());
                    var distanceOverlay = new kakao.maps.CustomOverlay({
                        content: '<div class="dotOverlay">거리 <span class="number">' + distance + '</span>m</div>',
                        position: new kakao.maps.LatLng((positions[i - 1].lat + positions[i].lat) / 2, (positions[i - 1].lon + positions[i].lon) / 2),
                        yAnchor: 1,
                        zIndex: 2
                    });

                    // 거리를 지도에 표시합니다
                    distanceOverlay.setMap(map);
                }
            }

            var polygons=[]; //function 안 쪽에 지역변수로 넣으니깐 폴리곤 하나 생성할 때마다 배열이 비어서 클릭했을 때 전체를 못 없애줌.  그래서 전역변수로 만듦.
            for (var i = 0; i < boundary.length; i++) {
                displayArea(boundary[i].coordinates, boundary[i].name);
            }

            //행정구역 폴리곤
            function displayArea(coordinates, name) {
                var path = [];            //폴리곤 그려줄 path
                var points = [];        //중심좌표 구하기 위한 지역구 좌표들
                for (var i = 0; i < coordinates.length; i++) {
                    var point = new Object();
                    point.x = coordinates[i][1];
                    point.y = coordinates[i][0];
                    points.push(point);
                    path.push(new kakao.maps.LatLng(coordinates[i][1], coordinates[i][0])); //new kakao.maps.LatLng가 없으면 인식을 못해서 path 배열에 추가
                }

                // 다각형을 생성합니다
                var polygon = new kakao.maps.Polygon({
                    map: map, // 다각형을 표시할 지도 객체
                    path: path,
                    strokeWeight: 2,
                    strokeColor: '#004c80',
                    strokeOpacity: 0.8,
                    fillColor: '#fff',
                    fillOpacity: 0.3
                });
                polygons.push(polygon);            //폴리곤 제거하기 위한 배열

                var locationOverlay = new kakao.maps.CustomOverlay({
                    content: '<div class="dotOverlay">' + name + '</div>',
                    position: centroid(points),
                    yAnchor: 1,
                    zIndex: 2
                });
                // 행정동을 지도에 표시합니다
                locationOverlay.setMap(map);

                // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다
                // 지역명을 표시하는 커스텀오버레이를 지도위에 표시합니다
                kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
                    polygon.setOptions({
                        fillColor : '#09f'
                    });
                });

                // 다각형에 mouseout 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 원래색으로 변경합니다
                // 커스텀 오버레이를 지도에서 제거합니다
                kakao.maps.event.addListener(polygon, 'mouseout', function() {
                    polygon.setOptions({
                        fillColor : '#fff',
                        fillOpacity: 0.3
                    });
                });

                // 다각형에 click 이벤트를 등록하고 이벤트가 발생하면 해당 지역 확대을 확대합니다.
                kakao.maps.event.addListener(polygon, 'click', function() {
                    // 현재 지도 레벨에서 2레벨 확대한 레벨
                    var level = map.getLevel()-2;
                    // 지도를 클릭된 폴리곤의 중앙 위치를 기준으로 확대합니다
                    map.setLevel(level, {anchor: centroid(points), animate: {
                            duration: 350            //확대 애니메이션 시간
                        }});
                    // deletePolygon(polygons);                    //폴리곤 제거
                });
            }

            //centroid 알고리즘 (폴리곤 중심좌표 구하기 위함)
            function centroid (points) {
                var i, j, len, p1, p2, f, area, x, y;
                area = x = y = 0;
                for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
                    p1 = points[i];
                    p2 = points[j];
                    f = p1.y * p2.x - p2.y * p1.x;
                    x += (p1.x + p2.x) * f;
                    y += (p1.y + p2.y) * f;
                    area += f * 3;
                }
                return new daum.maps.LatLng(x / area, y / area);
            }

            //지도 위 표시되고 있는 폴리곤 제거
            function deletePolygon(polygons) {
                for (var i = 0; i < polygons.length; i++) {
                    polygons[i].setMap(null);
                }
                polygons = [];
            }

        </script>
    </body>
</html>
